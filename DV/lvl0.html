<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>D3 Graph Visualization Demo</title>
  <link rel="icon" type="image/png" href="//static.epfl.ch/v0.26.1/favicon.png" />
  <!-- JavaScript Libraries //-->
  <script src="http://d3js.org/d3.v3.min.js"></script>

  <link href="style.css" rel="stylesheet" type="text/css">

  <script>
  //http://bl.ocks.org/sjengle/5432087
  //https://bl.ocks.org/mbostock/7607999
  //http://plnkr.co/edit/QR4rL5QlWF5fK3mI1nf8?p=preview
  //http://plnkr.co/edit/cVaILhLVwAumWr5QEvSW?p=preview
    var diameter = 900;
    var radius = diameter / 2;
    var margin = 50;



    // Generates a tooltip for a SVG circle element based on its ID
    function addTooltip(circle) {
      var x = parseFloat(circle.attr("cx"));
      var y = parseFloat(circle.attr("cy"));
      var r = parseFloat(circle.attr("r"));
      var text = circle.attr("id") + " main genre: "+circle.attr("genre");

      var tooltip = d3.select("#plot")
        .append("text")
        .text(text)
        .attr("x", x)
        .attr("y", y)
        .attr("dy", -r * 2)
        .attr("id", "tooltip");

      var offset = tooltip.node().getBBox().width / 2;

      if ((x - offset) < -radius) {
        tooltip.attr("text-anchor", "start");
        tooltip.attr("dx", -r);
      } else if ((x + offset) > (radius)) {
        tooltip.attr("text-anchor", "end");
        tooltip.attr("dx", r);
      } else {
        tooltip.attr("text-anchor", "middle");
        tooltip.attr("dx", 0);
      }
    }

    // Draws an arc diagram for the provided undirected graph
    function drawGraph(graph) {
      // create svg image
      var svg = d3.select("body").select("#circle")
        .append("svg")
        .attr("width", diameter)
        .attr("height", diameter);

      // create plot area within svg image
      var plot = svg.append("g")
        .attr("id", "plot")
        .attr("transform", "translate(" + radius + ", " + radius + ")");

      // draw border around plot area
       //plot.append("circle")
      //   .attr("class", "outline")
      //     .attr("r", radius - margin);

      // fix graph links to map to objects instead of indices
      //graph.links.forEach(function(d, i) {
      //  d.source = isNaN(d.source) ? d.source : graph.nodes[d.source];
      //  d.target = isNaN(d.target) ? d.target : graph.nodes[d.target];
      //});

      var links = [];

      graph.data.forEach(function(e) {
        var edgesList = e.edges;
        edgesList.forEach(function(f){
          targetNodeName = f[0];
          targetNode = graph.data.filter(function(n) {
              return n.year === targetNodeName;
          })[0];
          if(f[1]>0){
          links.push({
                source: e,
                target: targetNode,
                value: f[1]
            });}
          });
        });

      // calculate node positions
      circleLayout(graph.data);

      drawCurves(links);
      // draw nodes last
      drawNodes(graph.data);
      // draw edges first
      //drawLinks(graph.links);
    }

    // Calculates node locations
    function circleLayout(nodes) {

      // use to scale node index to theta value
      var scale = d3.scale.linear()
        .domain([0, nodes.length])
        .range([0, 2 * Math.PI]);

      // calculate theta for each node
      nodes.forEach(function(d, i) {
        // calculate polar coordinates
        var theta = scale(i);
        var radial = radius - margin;

        // convert to cartesian coordinates
        d.x = radial * Math.sin(theta);
        d.y = radial * Math.cos(theta);
      });
    }

    // Draws nodes with tooltips
    function drawNodes(nodes) {
      // used to assign nodes color by group
      var color = d3.scale.category20();

      d3.select("#plot").selectAll(".node")
        .data(nodes)
        .enter()
        .append("circle")
        .attr("class", "node")
        .attr("id", function(d, i) {
          return d.year;
        })
        .attr("genre", function(d, i) {
          return d.dom_genre;
        })
        .attr("cx", function(d, i) {
          return d.x;
        })
        .attr("cy", function(d, i) {
          return d.y;
        })
        .attr("r", 8)
        .style("fill", function(d, i) {
          return color(d.dom_genre);
        })
        .on("mouseover", mouseovered)
        .on("mouseout", mouseouted);
    }

    function mouseovered(d){
      addTooltip(d3.select(this));
    }

    function mouseouted(d){
        d3.select("#tooltip").remove();
    }

    function drawCurves(links) {
        // https://stackoverflow.com/questions/34263110/d3-js-edge-bundling-without-hierachy

        d3.select("#plot").selectAll(".link")
          .data(links)
          .enter()
          .append("path")
          .attr("class", "link")
          .attr("d", function(d){
            var lineData = [
            {
              x: Math.round(d.target.x),
              y: Math.round(d.target.y)
            }, {
              x: Math.round(d.target.x) - Math.round(d.target.x)/3,
              y: Math.round(d.target.y) - Math.round(d.target.y)/3
            },
            {
              x: Math.round(d.source.x) - Math.round(d.source.x)/3,
              y: Math.round(d.source.y) - Math.round(d.source.y)/3
            },{
              x: Math.round(d.source.x),
              y: Math.round(d.source.y)
            }];
            return `M${lineData[0].x},${lineData[0].y}C${lineData[1].x},${lineData[1].y},${lineData[2].x},${lineData[2].y},${lineData[3].x},${lineData[3].y} `;
          })
          .attr("stroke", function(d){
            var val = d.value;
            r = 200-val*200/10;
            g = 200-val*200/10;
            b = 200-val*200/10;
            return "rgb("+r+","+g+","+b+")";
          })
          .attr("stroke-width", function(d){
            var val = d.value;
            return 0.20*val+"px";
          });
      }
  </script>
</head>

<body>
  <div align="center" id="circle"></div>
  <script>
    d3.json("lvl0.json", drawGraph);
  </script>
</body>
</html>
